name: Tests

on:
  pull_request:
    branches:
      - dev
      - main
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  unit-tests:
    name: Tests Unitaris
    runs-on: ubuntu-latest
    
    # Evitar executar en PR en draft
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout del codi
        uses: actions/checkout@v4

      - name: Configurar Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Executar tests unitaris
        run: mvn clean test

      - name: Publicar resultats dels tests unitaris
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Resultats Tests Unitaris
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: Pujar informes de tests unitaris
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: target/surefire-reports/

  integration-tests:
    name: Tests d'Integraci√≥
    runs-on: ubuntu-latest
    needs: unit-tests

    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout del codi
        uses: actions/checkout@v4

      - name: Configurar Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Executar tests d'integraci√≥
        run: mvn clean verify -Dskip.unit.tests=true

      - name: Publicar resultats dels tests d'integraci√≥
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Resultats Tests d'Integraci√≥
          path: target/failsafe-reports/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: Pujar informes de tests d'integraci√≥
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-reports
          path: target/failsafe-reports/

  report-results:
    name: Comentar Resultats
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always() && github.event.pull_request.draft == false

    steps:
      - name: Comentar resultats en PR
        uses: actions/github-script@v7
        with:
          script: |
            const unitTestsResult = '${{ needs.unit-tests.result }}';
            const integrationTestsResult = '${{ needs.integration-tests.result }}';
            
            const unitIcon = unitTestsResult === 'success' ? '‚úÖ' : '‚ùå';
            const integrationIcon = integrationTestsResult === 'success' ? '‚úÖ' : '‚ùå';
            
            const body = `## üß™ Resultats dels Tests
            
            | Tipus de Test | Estat |
            |--------------|-------|
            | Tests Unitaris | ${unitIcon} ${unitTestsResult} |
            | Tests d'Integraci√≥ | ${integrationIcon} ${integrationTestsResult} |
            
            Revisa els detalls dels tests en els checks de GitHub Actions.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
